name: Publish
on:
  release:
    types: [published]
    
jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Download JAR
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: gradle.yml
        workflow_conclusion: success
        commit: ${{ github.sha }}
        name: FinalJAR
        path: ./downloads
    - name: Download POM file
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: gradle.yml
        commit: ${{ github.sha }}
        name: PomFile
        path: ./downloads
    - name: Upload setup
      working-directory: downloads
      shell: bash
      env:
        modified_gpg_executable: ${{ secrets.MODIFIED_GPG_EXECUTABLE }}
        secret_key: ${{ secrets.SECRET_KEY }}
        settings_xml: ${{ secrets.SETTINGS_XML }}
        gpg_passphrase: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        sudo apt install gnupg2
        sudo apt install maven
        printf "$secret_key" | base64 --decode > private.key
        echo $gpg_passphrase | gpg --batch --yes --passphrase-fd 0 --import private.key
        echo $modified_gpg_executable > modified_gpg_executable.sh
        chmod +x modified_gpg_executable.sh
        echo $settings_xml > settings.xml
        echo "sources_jar=$(find . -type f -name "*-sources.jar")" >> $GITHUB_ENV
        echo "javadoc_jar=$(find . -type f -name "*-javadoc.jar")" >> $GITHUB_ENV
        echo "lib_jar=$(find . -type f -name "*.[0-9].jar")" >> $GITHUB_ENV
        echo "pom_file=$(find . -type f -name "*.pom")" >> $GITHUB_ENV

    - name: Upload
      working-directory: downloads
      shell: bash
      env:
        modified_gpg_executable: ${{ secrets.MODIFIED_GPG_EXECUTABLE }}
        secret_key: ${{ secrets.SECRET_KEY }}
        settings_xml: ${{ secrets.SETTINGS_XML }}
        gpg_passphrase: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        mvn gpg:sign-and-deploy-file -Durl=https://oss.sonatype.org/service/local/staging/deploy/maven2/ -DrepositoryId=ossrh -DpomFile=$pom_file -Dfile=$lib_jar -Dpackaging=jar -s ./settings.xml -Dgpg.executable="./modified_gpg_executable.sh"
        mvn gpg:sign-and-deploy-file -Durl=https://oss.sonatype.org/service/local/staging/deploy/maven2/ -DrepositoryId=ossrh -DpomFile=$pom_file -Dfile=$javadoc_jar -Dpackaging=jar -Dclassifier=javadoc -s ./settings.xml -Dgpg.executable="./modified_gpg_executable.sh"
        mvn gpg:sign-and-deploy-file -Durl=https://oss.sonatype.org/service/local/staging/deploy/maven2/ -DrepositoryId=ossrh -DpomFile=$pom_file -Dfile=$sources_jar -Dpackaging=jar -Dclassifier=sources -s ./settings.xml -Dgpg.executable="./modified_gpg_executable.sh"
